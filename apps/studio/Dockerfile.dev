FROM node:20-slim
RUN npm install -g corepack@latest
RUN corepack enable && corepack prepare pnpm@10 --activate

WORKDIR /app

ENV WATCHPACK_POLLING=true
ENV NODE_ENV=development

# Copy only lockfile first for better caching
COPY pnpm-lock.yaml ./

# Fetch dependencies using lockfile
RUN pnpm fetch

COPY ./apps/studio/ .

# Install dependencies from offline cache
RUN pnpm install --prefer-offline

# Mount source code at runtime instead of copying
EXPOSE 3000

CMD ["pnpm", "dev"]

FROM node:20-slim
RUN corepack enable && corepack prepare pnpm@latest --activate

WORKDIR /app

ENV WATCHPACK_POLLING=true
ENV NODE_ENV=development

# Copy only lockfile first for better caching
COPY pnpm-lock.yaml ./

# Fetch dependencies using lockfile
RUN pnpm fetch
RUN pnpm fetch --dev

COPY ./apps/studio .

# Install dependencies from offline cache
RUN pnpm install --prefer-offline

# Mount source code at runtime instead of copying
EXPOSE 3000
CMD ["pnpm", "dev"]
